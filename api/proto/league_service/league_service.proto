syntax = "proto3";
package league_service;

option go_package = "github.com/domino14/liwords/rpc/api/proto/league_service";

import "proto/ipc/league.proto";
import "google/protobuf/timestamp.proto";

service LeagueService {
  // League management
  rpc CreateLeague(CreateLeagueRequest) returns (LeagueResponse);
  rpc GetLeague(LeagueRequest) returns (LeagueResponse);
  rpc GetAllLeagues(GetAllLeaguesRequest) returns (GetAllLeaguesResponse);
  rpc UpdateLeagueSettings(UpdateLeagueSettingsRequest)
      returns (LeagueResponse);
  rpc UpdateLeagueMetadata(UpdateLeagueMetadataRequest)
      returns (LeagueResponse);

  // Season management
  rpc BootstrapSeason(BootstrapSeasonRequest) returns (SeasonResponse);
  rpc GetSeason(SeasonRequest) returns (SeasonResponse);
  rpc GetCurrentSeason(LeagueRequest) returns (SeasonResponse);
  rpc GetPastSeasons(LeagueRequest) returns (PastSeasonsResponse);
  rpc GetAllSeasons(LeagueRequest) returns (AllSeasonsResponse);
  rpc OpenRegistration(OpenRegistrationRequest) returns (SeasonResponse);

  // Division and standings
  rpc GetDivisionStandings(DivisionRequest) returns (DivisionStandingsResponse);
  rpc GetAllDivisionStandings(SeasonRequest)
      returns (AllDivisionStandingsResponse);

  // Player management
  rpc RegisterForSeason(RegisterRequest) returns (RegisterResponse);
  rpc UnregisterFromSeason(UnregisterRequest) returns (UnregisterResponse);
  rpc GetSeasonRegistrations(SeasonRequest) returns (SeasonRegistrationsResponse);
  rpc GetPlayerLeagueHistory(PlayerHistoryRequest)
      returns (PlayerHistoryResponse);
  rpc GetPlayerSeasonGames(GetPlayerSeasonGamesRequest)
      returns (GetPlayerSeasonGamesResponse);
  rpc InviteUserToLeagues(InviteUserRequest) returns (InviteUserResponse);

  // Statistics (Phase 8)
  rpc GetLeagueStatistics(LeagueRequest) returns (LeagueStatisticsResponse);

  // Admin operations
  rpc MovePlayerToDivision(MovePlayerToDivisionRequest) returns (MovePlayerToDivisionResponse);
  rpc GetSeasonZeroMoveGames(SeasonRequest) returns (SeasonZeroMoveGamesResponse);
  rpc GetSeasonPlayersWithUnstartedGames(SeasonRequest) returns (SeasonPlayersWithUnstartedGamesResponse);
  rpc UpdateSeasonDates(UpdateSeasonDatesRequest) returns (SeasonResponse);
  rpc UpdateSeasonPromotionFormula(UpdateSeasonPromotionFormulaRequest) returns (SeasonResponse);
}

message CreateLeagueRequest {
  string name = 1;
  string description = 2;
  string slug = 3;
  ipc.LeagueSettings settings = 4;
}

message LeagueRequest {
  string league_id = 1; // UUID or slug
}

message GetAllLeaguesRequest { bool active_only = 1; }

message GetAllLeaguesResponse { repeated ipc.League leagues = 1; }

message LeagueResponse { ipc.League league = 1; }

message UpdateLeagueSettingsRequest {
  string league_id = 1;
  ipc.LeagueSettings settings = 2;
}

message UpdateLeagueMetadataRequest {
  string league_id = 1;
  string name = 2;
  string description = 3;
}

message SeasonRequest { string season_id = 1; }

message SeasonResponse { ipc.Season season = 1; }

message PastSeasonsResponse { repeated ipc.Season seasons = 1; }

message AllSeasonsResponse { repeated ipc.Season seasons = 1; }

message BootstrapSeasonRequest {
  string league_id = 1;
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
  ipc.SeasonStatus status = 4; // Explicit status (SCHEDULED, ACTIVE)
}

message OpenRegistrationRequest {
  string league_id = 1; // UUID or slug (for context, not used)
  string season_id = 2;  // Required: UUID of season to open registration for
}

message DivisionRequest { string division_id = 1; }

message DivisionStandingsResponse { ipc.Division division = 1; }

message AllDivisionStandingsResponse { repeated ipc.Division divisions = 1; }

message RegisterRequest {
  string league_id = 1;
  string user_id = 2;
  string season_id = 3;
}

message RegisterResponse {
  bool success = 1;
  string season_id = 2;
}

message UnregisterRequest {
  string season_id = 1;
  string user_id = 2;
}

message UnregisterResponse { bool success = 1; }

message SeasonRegistrationsResponse {
  repeated SeasonRegistration registrations = 1;
}

message SeasonRegistration {
  string user_id = 1;
  string username = 2;
  string season_id = 3;
  string division_id = 4; // Empty if not assigned to division yet
  int32 division_number = 5; // 0 if not assigned to division yet
}

message PlayerHistoryRequest {
  string user_id = 1;
  string league_id = 2; // Optional: filter by specific league
}

message PlayerHistoryResponse { repeated SeasonSummary seasons = 1; }

message SeasonSummary {
  string season_id = 1;
  int32 season_number = 2;
  string league_name = 3;
  int32 division_number = 4;
  ipc.LeaguePlayerStanding standing = 5;
}

message LeagueStatisticsResponse {
  // Phase 8 implementation
  repeated LeagueStat stats = 1;
}

message LeagueStat {
  string stat_type = 1;
  string user_id = 2;
  string username = 3;
  int32 value = 4;
  string game_id = 5;
  int32 division_number = 6;
}

message GetPlayerSeasonGamesRequest {
  string user_id = 1;
  string season_id = 2;
}

message GetPlayerSeasonGamesResponse {
  repeated PlayerSeasonGame games = 1;
}

message PlayerSeasonGame {
  string game_id = 1;
  string opponent_user_id = 2;
  string opponent_username = 3;
  int32 player_score = 4;
  int32 opponent_score = 5;
  string result = 6; // "win", "loss", "draw", "in_progress"
  google.protobuf.Timestamp game_date = 7;
  int32 round = 8; // Optional round number
}

message InviteUserRequest {
  string user_id = 1; // UUID of user to invite
}

message InviteUserResponse {
  bool success = 1;
  string message = 2;
}

message MovePlayerToDivisionRequest {
  string user_id = 1;        // UUID of player to move
  string season_id = 2;       // UUID of season
  string from_division_id = 3; // UUID of current division
  string to_division_id = 4;   // UUID of target division
}

message MovePlayerToDivisionResponse {
  bool success = 1;
  string message = 2;
}

message SeasonZeroMoveGamesResponse {
  repeated ZeroMoveGame games = 1;
}

message ZeroMoveGame {
  string game_id = 1;
  google.protobuf.Timestamp created_at = 2;
  string player0_id = 3;
  string player0_username = 4;
  string player1_id = 5;
  string player1_username = 6;
  string division_id = 7;
}

message SeasonPlayersWithUnstartedGamesResponse {
  repeated PlayerWithUnstartedGames players = 1;
}

message PlayerWithUnstartedGames {
  string user_id = 1;
  string username = 2;
  int32 unstarted_game_count = 3;
}

message UpdateSeasonDatesRequest {
  string season_id = 1;
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
}

message UpdateSeasonPromotionFormulaRequest {
  string season_id = 1;
  ipc.PromotionFormula promotion_formula = 2;
}
