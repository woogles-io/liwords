syntax = "proto3";
package ipc;

import "proto/ipc/omgwords.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/domino14/liwords/rpc/api/proto/ipc";

message League {
    string uuid = 1;
    string name = 2;
    string description = 3;
    string slug = 4;
    LeagueSettings settings = 5;
    string current_season_id = 6;
    bool is_active = 7;
}

message LeagueSettings {
    int32 season_length_days = 1;
    TimeControl time_control = 3;
    string lexicon = 4;
    string variant = 5;
    int32 ideal_division_size = 6;
    ChallengeRule challenge_rule = 9;
}

message TimeControl {
    int32 increment_seconds = 1;
    int32 time_bank_minutes = 2;
}

message Season {
    string uuid = 1;
    string league_id = 2;
    int32 season_number = 3;
    google.protobuf.Timestamp start_date = 4;
    google.protobuf.Timestamp end_date = 5;
    google.protobuf.Timestamp actual_end_date = 6;
    SeasonStatus status = 7;
    repeated Division divisions = 8;
    PromotionFormula promotion_formula = 9;  // How to calculate promotion/relegation counts
}

enum SeasonStatus {
    SEASON_SCHEDULED = 0;
    SEASON_ACTIVE = 1;
    SEASON_COMPLETED = 2;
    SEASON_CANCELLED = 3;
    SEASON_REGISTRATION_OPEN = 4;
}

// PromotionFormula defines how many players are promoted/relegated per division
enum PromotionFormula {
    PROMO_N_DIV_6 = 0;       // ceil(N/6) - default, e.g. 15 players = 3 promoted/relegated
    PROMO_N_PLUS_1_DIV_5 = 1; // ceil((N+1)/5), e.g. 15 players = 4 promoted/relegated
    PROMO_N_DIV_5 = 2;       // ceil(N/5), e.g. 15 players = 3 promoted/relegated
    PROMO_N_DIV_3 = 3;       // ceil(N/3), e.g. 15 players = 5 promoted/relegated
}

message Division {
    string uuid = 1;
    string season_id = 2;
    int32 division_number = 3;
    string division_name = 4;
    repeated PlayerRegistration players = 5;
    repeated string game_ids = 6;
    repeated LeaguePlayerStanding standings = 7;
    bool is_complete = 8;
}

message PlayerRegistration {
    string user_id = 1;
    string username = 2;
    string division_id = 3;
    google.protobuf.Timestamp registration_date = 4;
    int32 firsts_count = 5;
    string status = 6;
}

message LeaguePlayerStanding {
    string user_id = 1;
    string username = 2;
    int32 rank = 3;
    int32 wins = 4;
    int32 losses = 5;
    int32 draws = 6;
    int32 spread = 7;
    int32 games_played = 8;
    int32 games_remaining = 9;
    StandingResult result = 10;
    // Extended stats for richer leaderboard display
    int32 total_score = 11;           // Sum of scores (for ScAV = total_score / games_played)
    int32 total_opponent_score = 12;  // Sum of opponent scores (for OScAV)
    int32 total_bingos = 13;          // Sum of bingos (for BAV = total_bingos / games_played)
    int32 total_opponent_bingos = 14; // Sum of opponent bingos (for OBAV)
    int32 total_turns = 15;           // Sum of turns (for #TAV = total_turns / games_played)
    int32 high_turn = 16;             // Highest single turn score (HT)
    int32 high_game = 17;             // Highest game score (HG)
    int32 timeouts = 18;              // Number of timeout losses (#TO)
    int32 blanks_played = 19;         // Number of blanks played (for ?AV = blanks_played / games_played)
    int32 total_tiles_played = 20;    // Sum of tiles played (for TAV = total_tiles_played / games_played)
    int32 total_opponent_tiles_played = 21; // Sum of opponent tiles played (for OTAV)
    PlacementStatus placement_status = 22;  // How player was placed in this division (NEW, PROMOTED, etc.)
}

enum StandingResult {
    RESULT_NONE = 0;
    RESULT_PROMOTED = 1;
    RESULT_RELEGATED = 2;
    RESULT_STAYED = 3;
    RESULT_CHAMPION = 4;
}

// PlacementStatus indicates a player's status for next season placement
enum PlacementStatus {
    PLACEMENT_NONE = 0;
    PLACEMENT_NEW = 1;  // Brand new player
    PLACEMENT_PROMOTED = 3;  // Promoted from lower division
    PLACEMENT_RELEGATED = 4;  // Relegated from higher division
    PLACEMENT_STAYED = 5;  // Stayed in same division
    PLACEMENT_SHORT_HIATUS_RETURNING = 6;  // Returning after 1-3 seasons
    PLACEMENT_LONG_HIATUS_RETURNING = 7;  // Returning after 4+ seasons
}

message TimeBankWarning {
    string user_id = 1;
    string username = 2;
    int32 low_timebank_game_count = 3;  // Number of games with time bank below threshold
}

message GetDivisionTimeBankWarningsRequest {
    string division_id = 1;
    int32 threshold_hours = 2;  // Time bank threshold in hours (e.g., 24 for 1 day)
}

message GetDivisionTimeBankWarningsResponse {
    repeated TimeBankWarning warnings = 1;
}
